package DataAccessLayer.Inventory.DataAccessObjects;

import PresentationLayer.Inventory.DataTransferObjects.DataTransferObject;

import java.sql.*;
import java.util.ArrayList;

public abstract class DataAccessObject {
    protected Connection c = null;
    protected String databaseUrl;
    protected String tableName;
    protected String primaryKey = "ID";

    public DataAccessObject() {
        this.databaseUrl = "jdbc:sqlite::resource:module.db";
    }

    public DataAccessObject(String databaseUrl) {
        this.databaseUrl = databaseUrl;
    }

    void close() throws SQLException {
        c.commit();
        c.close();
        c  = null;
    }

    public boolean insert(DataTransferObject dataTransferObject) {
        try {
            c = this.connect();
            PreparedStatement stmt = createInsertPreparedStatement(dataTransferObject);
            int rowsAffected = stmt.executeUpdate();

            close();
            return rowsAffected>0;
        }
        catch (SQLException e) {
            handleError(e);
            try {
                c.close();
                return false;
            }
            catch (SQLException exception) {
                handleError(e);
                return false;
            }
        }
    }

    public boolean update(DataTransferObject dataTransferObject) {
        try {
            c = this.connect();
            PreparedStatement stmt = createUpdatePreparedStatement(dataTransferObject);
            int rowsAffected = stmt.executeUpdate();

            close();
            return rowsAffected>0;
        }
        catch (SQLException e) {
            handleError(e);
            try {
                c.close();
                return false;
            }
            catch (SQLException exception) {
                handleError(e);
                return false;
            }
        }
    }

    /**
     * If a primary key was autogenerated in the table, returns that key. Otherwise, returns -1
     */
    public int insertWithAI(DataTransferObject dataTransferObject) {
        try {
            c = this.connect();
            PreparedStatement stmt = createInsertPreparedStatement(dataTransferObject);
            stmt.executeUpdate();
            ResultSet result = stmt.getGeneratedKeys();

            int generatedId = -1;

            if (result.next()){
                generatedId = result.getInt(1);
            }
            close();
            return generatedId;
        }
        catch (SQLException e) {
            handleError(e);
            try {
                c.close();
                return -1;
            }
            catch (SQLException exception) {
                handleError(e);
                return -1;
            }
        }
    }

    protected abstract PreparedStatement createInsertPreparedStatement(DataTransferObject dataTransferObject) throws SQLException;
    protected abstract PreparedStatement createUpdatePreparedStatement(DataTransferObject dataTransferObject) throws SQLException;

    public ArrayList<DataTransferObject> selectAllGeneric (){
        try {
            c = this.connect();
            Statement stmt = c.createStatement();
            String sql = "SELECT * FROM " + tableName;
            ResultSet result = stmt.executeQuery(sql);

            ArrayList<DataTransferObject> dataTransferObjects = new ArrayList<>();
            while (result.next()){
                dataTransferObjects.add(resultToDTO(result));
            }
            close();
            return dataTransferObjects;
        }
        catch (SQLException e) {
            handleError(e);
            return null;
        }
    }

    public <T extends DataTransferObject> T get(int id){
        try {
            c = this.connect();
            Statement stmt = c.createStatement();
            String sql = String.format("SELECT * FROM %s WHERE %s = %d", tableName,primaryKey, id);;
            ResultSet result = stmt.executeQuery(sql);
            T dataTransferObject = null;
            if (result.next()){
                dataTransferObject = resultToDTO(result);
            }
            close();
            return dataTransferObject;
        }
        catch (SQLException e) {
            handleError(e);
            return null;
        }
    }

    public boolean delete(int id){
        try {
            c = this.connect();
            Statement stmt = c.createStatement();
            String sql = "DELETE FROM " + tableName + " WHERE "+ primaryKey +" = " + id;
            int rowsAffected = stmt.executeUpdate(sql);
            close();

            return rowsAffected > 0;
        }
        catch (SQLException e) {
            handleError(e);
            return false;
        }
    }

    void handleError(SQLException e) {
        System.err.println( e.getClass().getName() + ": On table " + tableName + " : " + e.getMessage() );
        try {
            c.close();
        }
        catch (SQLException exception) {
            System.err.println( exception.getClass().getName() + ": On table " + tableName + " : " + exception.getMessage() );
        }
    }

    protected abstract <T extends DataTransferObject> T resultToDTO(ResultSet resultSet) throws SQLException;


    Connection connect() {
        // SQLite connection string
        String url = "jdbc:sqlite::resource:module.db";
        Connection conn = null;
        try {
            conn = DriverManager.getConnection(databaseUrl);
            conn.setAutoCommit(false);
        } catch (SQLException e) {
            System.out.println(e.getMessage());
        }
        return conn;
    }
}
